// Code generated DO NOT EDIT
// This code is AUTOGENERATED and will be overwritten by "go generate", so
// editing this file is a waste of time. To make changes, edit the template
// in pkg/generator/template/subcommand.tmpl. If you want to execute things
// before or after the command is executed, use a hook. See the usage_hook.go
// as an example.

package {{.Definition.Name}}

import (
	cloudv1 "buf.build/gen/go/gportal/gportal-cloud/protocolbuffers/go/gpcloud/api/cloud/v1"
	"encoding/json"
	"github.com/G-PORTAL/gpcloud-go/pkg/gpcloud/client"
	"github.com/spf13/cobra"
    {{- if ne .Definition.Identifier "" }}
	"gpcloud-cli/pkg/config"
	{{- end}}
)
{{range $key, $value := .Action.Params}}
var {{$key}} {{$value}}
{{- end}}

var {{.Name|ToCamel}}Cmd = &cobra.Command{
	Use:                   "{{.Name}}",
	Short:                 "{{.Action.Description}}",
	Long:                  "{{.Action.Description}}",
	DisableFlagsInUseLine: true,
	Args:                  cobra.OnlyValidArgs,
	{{- if gt (len .Action.Params) 0}}
	ValidArgs: []string{
	    {{range $key, $value := .Action.Params}}"{{$key}}",
	    {{- end}}
	},
	{{end}}
	RunE: func(cmd *cobra.Command, args []string) error {
		conn := cmd.Context().Value("conn").(*client.Client)
		{{- if ne .Definition.Identifier "" }}
		session := cmd.Context().Value("session").(*config.SessionConfig)
        {{- end}}
		resp, err := conn.{{.Action.APICall.Client|Title}}Client().{{.Action.APICall.Endpoint}}(cmd.Context(), &cloudv1.{{.Action.APICall.Endpoint}}Request{
		    {{- if ne .Definition.Identifier "" }}
		    Id:       *{{.Definition.Identifier}},
		    {{- end}}
	        {{- range $key, $value := .Action.Params}}
	        {{$key|Title}}: {{$key}},
	        {{- end}}
		})
		if err != nil {
			return err
		}

		// TODO: Call hook if exist

        {{- if HasPrefix .Action.APICall.Endpoint "List" }}
        // Format list
		{{- if eq .Action.RootKey ""}}
		jsonData, err := json.MarshalIndent(resp.{{.Name|Pluralize|ToCamel|Title}}, "", "  ")
		{{- else}}
		jsonData, err := json.MarshalIndent(resp.{{.Action.RootKey}}, "", "  ")
        {{- end}}
		if err != nil {
			return err
		}
		{{- else}}
		jsonData, err := json.MarshalIndent(resp, "", "  ")
		{{- end}}


		// TODO: Set the header from the child elements
		// TODO: Append rows from the child elements
		// TODO: Render the table
		// TODO: Handle nested structures

		// TODO: Only Output response as json if requests with --json flag,
		// Otherwise, output a human readable table
		cmd.Println(string(jsonData))

		return nil
	},
}

func init() {
    {{- $subcommand := .Name}}
    {{- range $key, $value := .Action.Params}}
    {{- $datatypeDefaultValue := "nil"}}
    {{- if eq $value "string"}}
      {{- $datatypeDefaultValue = `""`}}
    {{- end}}
    {{- if eq $value "bool"}}
      {{- $datatypeDefaultValue = `false`}}
    {{- end}}
    {{- if eq $value "int"}}
      {{- $datatypeDefaultValue = `0`}}
    {{- end}}
    {{$subcommand}}Cmd.Flags().{{$value|Title}}Var(&{{$key}}, "{{$key}}", {{$datatypeDefaultValue}}, "TODO: Add description")
    {{- end}}

	Root{{.Definition.Name|Title}}Command.AddCommand({{$subcommand|ToCamel}}Cmd)
}
